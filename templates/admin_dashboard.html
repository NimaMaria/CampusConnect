<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusConnect - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  :root{
    --bg1:#ffffff;
    --bg2:#f4faff;
    --bg3:#e8f5ff;

    --accent1:#3aa6ff;
    --accent2:#1f8fff;

    --text:#0f172a;
    --muted:#6b7280;

    --card:rgba(255,255,255,0.95);
    --border:rgba(58,166,255,0.20);
    --shadow:0 12px 30px rgba(58,166,255,0.15);
  }

  body{
    min-height:100vh;
    background:
      radial-gradient(900px 500px at 15% 20%, rgba(58,166,255,0.15), transparent 60%),
      radial-gradient(900px 500px at 85% 10%, rgba(58,166,255,0.12), transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
    color:var(--text);
  }

  .glass{
    background:rgba(255,255,255,0.92);
    backdrop-filter: blur(10px);
    border:1px solid rgba(58,166,255,0.15);
    box-shadow:0 10px 25px rgba(58,166,255,0.10);
    border-radius:18px;
  }

  .brand{font-weight:800;}
  .muted{color:var(--muted);}

  .btn-gradient{
    border:none;
    color:#fff;
    background: linear-gradient(90deg, #3aa6ff, #1f8fff);
    font-weight:800;
  }

  .section-card{
    background:rgba(255,255,255,0.95);
    border:1px solid rgba(58,166,255,0.18);
    box-shadow:0 8px 20px rgba(58,166,255,0.08);
    border-radius:18px;
    padding:16px;
  }

  .toast-msg{
    display:none;
    margin-top:12px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(58,166,255,0.25);
    background:rgba(255,255,255,0.95);
    font-weight:800;
  }
  .toast-success{ border-color: rgba(34,197,94,0.35); }
  .toast-danger{ border-color: rgba(239,68,68,0.35); }
  .toast-warning{ border-color: rgba(245,158,11,0.40); }

  .events-list{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:10px;
  }

  .event-row{
    display:flex;
    gap:12px;
    align-items:center;
    background:var(--card);
    border:1px solid rgba(58,166,255,0.15);
    border-radius:18px;
    overflow:hidden;
    cursor:pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease;
  }

  .event-row:hover{
    transform: translateY(-2px);
    box-shadow:0 8px 20px rgba(58,166,255,0.15);
  }

  .event-poster{
    width:160px;
    min-width:160px;
    height:110px;
    background: rgba(240,248,255,0.9);
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    color:rgba(15,23,42,0.55);
    font-weight:800;
  }

  .event-poster img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }

  .event-info{
    flex:1;
    padding:14px 10px 14px 0;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }

  .event-title{
    margin:0;
    font-weight:850;
    font-size:18px;
    line-height:1.2;
  }

  .meta-line{
    margin-top:6px;
    font-size:13px;
    color:var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(58,166,255,0.20);
    background:rgba(58,166,255,0.08);
    font-size:12px;
    font-weight:700;
  }

  .delete-wrap{padding:10px 12px 10px 0;}

  .domain-btn{
    border:none;
    color:#fff;
    font-weight:800;
    padding:8px 14px;
    border-radius:999px;
    background: linear-gradient(90deg, #3aa6ff, #1f8fff);
    white-space:nowrap;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
  }

  .modal-poster{
    width:100%;
    border-radius:14px;
    overflow:hidden;
    border:1px solid rgba(58,166,255,0.20);
    background: rgba(240,248,255,0.9);
    max-height:70vh;
  }

  .modal-poster img{
    width:100%;
    height:auto;
    display:block;
    max-height:70vh;
    object-fit:contain;
  }

  .modal-content-scroll{
    max-height:260px;
    overflow:auto;
    padding-right:6px;
    white-space:pre-wrap;
    color:rgba(15,23,42,0.9);
  }

  .register-btn{
    padding: 14px 36px;
    font-size: 17px;
    font-weight: 900;
    border-radius: 14px;
    min-width: 240px;
    background: linear-gradient(90deg, #3aa6ff, #1f8fff);
    color:#fff;
    border:none;
    box-shadow:0 8px 18px rgba(58,166,255,0.25);
    transition:all 0.15s ease;
    text-decoration:none;
    display:inline-block;
  }

  .register-btn:hover{
    transform: translateY(-2px);
    box-shadow:0 12px 24px rgba(58,166,255,0.35);
    color:#fff;
  }

  #formWrap{ display:none; }
  </style>
</head>

<body>
  <nav class="navbar sticky-top" style="background: rgba(255,255,255,0.60); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(15,23,42,0.10);">
    <div class="container py-1">
      <span class="navbar-brand brand">CampusConnect - Admin</span>
      <span class="muted" style="font-size:13px;">Add events for students</span>
    </div>
  </nav>

  <main class="container py-4">
    <section class="glass p-3 p-md-4">

      <div class="section-card">
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2">
          <div>
            <h1 class="h5 mb-1" style="font-weight:850;">Add Event</h1>
            <div class="muted">Upload poster + enter details</div>
          </div>
          <button type="button" class="btn btn-gradient" id="openFormBtn">+ Add Event</button>
        </div>

        <div id="toastMsg" class="toast-msg"></div>

        <div id="formWrap" class="mt-3">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label fw-semibold">Event Name</label>
              <input class="form-control" id="name" placeholder="Eg: Tech Talk" />
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold">Date</label>
              <input class="form-control" id="date" placeholder="YYYY-MM-DD" />
            </div>

            <div class="col-md-3">
              <label class="form-label fw-semibold">Time</label>
              <input class="form-control" id="time" placeholder="10:00 AM" />
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Domain</label>
              <select class="form-select" id="domain" required>
                <option value="">Select Domain</option>
                <option value="Tech">Tech</option>
                <option value="Cultural">Cultural</option>
                <option value="Fun">Fun</option>
                <option value="Sports">Sports</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Poster (choose from gallery)</label>
              <input class="form-control" type="file" id="poster" accept="image/*" />
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Content / Description</label>
              <textarea class="form-control" id="content" rows="3" placeholder="Write poster content/details..."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Registration Link (Required)</label>
              <input class="form-control" id="reg_link" placeholder="https://forms.gle/..." />
            </div>

            <div class="col-12 d-flex gap-2">
              <button type="button" class="btn btn-gradient" id="submitBtn">Submit</button>
              <button type="button" class="btn btn-outline-dark" id="cancelBtn">Cancel</button>
            </div>

          </div>
        </div>
      </div>

      <div class="mt-4">
        <h2 class="h6 fw-bold mb-2" style="letter-spacing:0.6px;">ALL EVENTS</h2>
        <div class="events-list" id="eventsList"></div>
        <div class="muted mt-2" id="emptyState" style="display:none;">No events yet. Add your first event.</div>
      </div>

    </section>
  </main>

  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="border-radius:18px; overflow:hidden;">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="modalTitle" style="font-weight:850; margin:0;">Event</h5>
            <div class="mt-1" id="modalMeta" style="font-size:13px; color:#64748b;"></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="modal-poster mb-3" id="modalPoster"></div>

          <div class="fw-bold mb-1">Content</div>
          <div class="modal-content-scroll" id="modalContent"></div>

          <div class="mt-4 text-center">
            <a id="registerBtn"
               class="register-btn"
               href="#"
               target="_blank"
               rel="noopener"
               style="display:none;">
              Register Now
            </a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let eventsById = {};
    let toastTimer = null;

    function showToast(text, type="success"){
      const el = document.getElementById("toastMsg");
      el.className = "toast-msg";
      el.style.display = "block";
      el.textContent = text;

      if(type === "success") el.classList.add("toast-success");
      if(type === "danger") el.classList.add("toast-danger");
      if(type === "warning") el.classList.add("toast-warning");

      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.style.display = "none";
        el.textContent = "";
      }, 2000);
    }

    function openForm(){ document.getElementById("formWrap").style.display = "block"; }
    function closeForm(){ document.getElementById("formWrap").style.display = "none"; }

    function clearForm(){
      ["name","date","time","domain","reg_link","content"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("poster").value = "";
    }

    function formatDate(iso){
      if(!iso) return "";
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }

    function rowHTML(ev){
      const poster = ev.poster_url
        ? `<img src="${ev.poster_url}" alt="poster">`
        : `<div>${ev.domain || "Poster"}</div>`;

      const domainChip = `<span class="domain-btn">${ev.domain || "Domain"}</span>`;

      return `
        <div class="event-row" data-id="${ev.id}">
          <div class="event-poster">${poster}</div>

          <div class="event-info">
            <p class="event-title">${ev.name || "Event"}</p>
            <div class="meta-line">
              <span class="pill">üìÖ ${formatDate(ev.date) || "-"}</span>
              <span class="pill">‚è∞ ${ev.time || "-"}</span>
            </div>
          </div>

          <div style="padding:10px 0;">
            ${domainChip}
          </div>

          <div class="delete-wrap">
            <button type="button" class="btn btn-sm btn-outline-danger delete-btn" data-id="${ev.id}">üóë</button>
          </div>
        </div>
      `;
    }

    function openEventModal(ev){
      document.getElementById("modalTitle").textContent = ev.name || "Event";
      document.getElementById("modalMeta").textContent =
        `${formatDate(ev.date)}${ev.time ? " ‚Ä¢ " + ev.time : ""} ‚Ä¢ ${ev.domain || ""}`.trim();

      const poster = document.getElementById("modalPoster");
      poster.innerHTML = ev.poster_url
        ? `<img src="${ev.poster_url}" alt="poster">`
        : `<div style="padding:60px 0; text-align:center; font-weight:800; color:rgba(15,23,42,0.55);">
            ${ev.domain || "Poster"}
          </div>`;

      document.getElementById("modalContent").textContent = ev.content || "";

      const registerBtn = document.getElementById("registerBtn");
      let link = (ev.reg_link || "").trim();

      if(link){
        if(!link.startsWith("http")) link = "https://" + link;
        registerBtn.href = link;
        registerBtn.style.display = "inline-block";
      } else {
        registerBtn.style.display = "none";
      }

      new bootstrap.Modal(document.getElementById("eventModal")).show();
    }

    async function loadEvents(){
      const res = await fetch("/api/events?domain=All");
      const data = await res.json();

      eventsById = {};
      data.forEach(ev => eventsById[String(ev.id)] = ev);

      const list = document.getElementById("eventsList");
      list.innerHTML = data.map(rowHTML).join("");

      document.getElementById("emptyState").style.display = data.length ? "none" : "block";
    }

    document.addEventListener("click", async (e) => {
      const delBtn = e.target.closest(".delete-btn");
      if (delBtn){
        e.stopPropagation();
        const id = delBtn.getAttribute("data-id");

        if(!confirm("Delete this event?")) return;

        const res = await fetch(`/api/events/${id}`, { method: "DELETE" });
        if(res.ok){
          showToast("‚úÖ Event deleted", "success");
          loadEvents();
        }else{
          showToast("‚ùå Delete failed", "danger");
        }
        return;
      }

      const row = e.target.closest(".event-row");
      if(row){
        const id = row.getAttribute("data-id");
        const ev = eventsById[id];
        if(ev) openEventModal(ev);
      }
    });

    async function addEvent(){
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      const name = document.getElementById("name").value.trim();
      const date = document.getElementById("date").value.trim();
      const time = document.getElementById("time").value.trim();
      const domain = document.getElementById("domain").value.trim();
      const content = document.getElementById("content").value.trim();
      const reg_link = document.getElementById("reg_link").value.trim();
      const posterFile = document.getElementById("poster").files[0];

      if(!name){ showToast("Event name is required", "warning"); submitBtn.disabled=false; submitBtn.textContent="Submit"; return; }
      if(!date){ showToast("Date is required", "warning"); submitBtn.disabled=false; submitBtn.textContent="Submit"; return; }
      if(!domain){ showToast("Domain is required", "warning"); submitBtn.disabled=false; submitBtn.textContent="Submit"; return; }
      if(!reg_link){ showToast("Registration link is required", "warning"); submitBtn.disabled=false; submitBtn.textContent="Submit"; return; }

      const fd = new FormData();
      fd.append("name", name);
      fd.append("date", date);
      fd.append("time", time);
      fd.append("domain", domain);
      fd.append("content", content);
      fd.append("reg_link", reg_link);
      if(posterFile) fd.append("poster", posterFile);

      try{
        const res = await fetch("/api/events", { method:"POST", body: fd });
        const json = await res.json();

        if(res.ok){
          showToast("‚úÖ Event added", "success");
          await loadEvents();
          clearForm();
          closeForm();
        }else{
          showToast("‚ùå " + (json.error || "Failed"), "danger");
        }
      }catch(err){
        showToast("‚ùå Submit failed", "danger");
        console.error(err);
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("openFormBtn").addEventListener("click", openForm);
      document.getElementById("submitBtn").addEventListener("click", addEvent);
      document.getElementById("cancelBtn").addEventListener("click", () => { clearForm(); closeForm(); });

      loadEvents();
    });
  </script>
</body>
</html>
